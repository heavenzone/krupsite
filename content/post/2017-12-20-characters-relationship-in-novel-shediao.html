---
title: 用R语言对《射雕英雄传》分词分析
author: Heaven Zone
date: '2017-12-20'
slug: characters-relationship-in-novel-shediao
categories:
  - 文本挖掘
tags:
  - 文本挖掘
  - R语言
  - 射雕英雄传
description: '射雕英雄传人物关系图，用R语言对《射雕英雄传》分词分析'
keywords: "R语言,文本挖掘,射雕英雄传"
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/pymjs/pym.v1.js"></script>
<script src="/rmarkdown-libs/widgetframe-binding/widgetframe.js"></script>
<link href="/rmarkdown-libs/wordcloud2/wordcloud.css" rel="stylesheet" />
<script src="/rmarkdown-libs/wordcloud2/wordcloud2-all.js"></script>
<script src="/rmarkdown-libs/wordcloud2/hover.js"></script>
<script src="/rmarkdown-libs/wordcloud2-binding/wordcloud2.js"></script>


<div class="section level2">
<h2>简介</h2>
<p>目标：对《射雕英雄传》进行分词分析，画出人物云图和人物关系图。</p>
<p>人物关系算法参考<a href="https://zhuanlan.zhihu.com/p/26104216">这里</a>。</p>
</div>
<div class="section level2">
<h2>软件包准备</h2>
<div class="section level3">
<h3>安装软件包</h3>
<p>主要用到下面几个软件包：</p>
<ul>
<li>jiebaR</li>
<li>cidian</li>
<li>ggnetwork</li>
<li>igraph</li>
</ul>
<p>首先应该把<strong>devtools</strong>安装好了，也就是一条命令<code>install.packages(&quot;devtools&quot;)</code>。</p>
<p>然后就可以输入下面几条命令安装本文档所需的软件包的最新版了：</p>
<pre class="r"><code>library(devtools)
install_github(&quot;qinwf/jiebaRD&quot;)
install_github(&quot;qinwf/jiebaR&quot;)
install.packages(&quot;stringi&quot;)
install.packages(&quot;pbapply&quot;)
install.packages(&quot;Rcpp&quot;)
install.packages(&quot;RcppProgress&quot;)
install_github(&quot;qinwf/cidian&quot;)
install.packages(&quot;text2vec&quot;)
install.packages(&quot;tm&quot;)
install.packages(&quot;intergraph&quot;) # 连接ggnetwork和igraph
install.packages(&quot;ggnetwork&quot;) # 画关系图
install.packages(&quot;igraph&quot;) # graph.data.frame</code></pre>
</div>
<div class="section level3">
<h3>载入软件包</h3>
<pre class="r"><code>library(cidian)
library(jiebaR)
library(data.table)
library(wordcloud2)
library(tm)</code></pre>
</div>
</div>
<div class="section level2">
<h2>词库准备</h2>
<div class="section level3">
<h3>下载搜狗细胞词库</h3>
<p>首先到这里<a href="https://pinyin.sogou.com/dict/search/search_list/%BD%F0%D3%B9/normal">细胞词库下载地址</a>下载搜狗的细胞词库。</p>
<p>一共下载了下面6个词库。</p>
<pre class="r"><code>dir(path = &quot;../../data/20171220-shediao/&quot;, pattern = &quot;scel$&quot;)</code></pre>
<pre><code>## [1] &quot;金庸独特地名.scel&quot;               &quot;金庸人名.scel&quot;                  
## [3] &quot;金庸武功招式.scel&quot;               &quot;金庸武侠小说中出现的门派名.scel&quot;
## [5] &quot;金庸小说武器.scel&quot;               &quot;金庸小说中的药物.scel&quot;</code></pre>
</div>
<div class="section level3">
<h3>转换词库</h3>
<p>下面将搜狗的细胞词库转换成jiebaR的用户词库:</p>
<pre class="r"><code># 如果已经存在.scel.txt文件，把他们删除
tmp &lt;- list.files(path = &quot;../../data/20171220-shediao/&quot;,pattern = &quot;.scel.txt$&quot;,full.names = T) 
if(length(tmp) &gt;= 1) {
  lapply(tmp,function(x){
    file.remove(x)
  }) %&gt;% invisible()
}

# 重新生成.scel.txt，用户词典
tmp &lt;- list.files(path = &quot;../../data/20171220-shediao/&quot;,pattern = &quot;.scel$&quot;,full.names = T) 
scelFiles &lt;- paste0(getwd(), &quot;/&quot;, tmp)
lapply(scelFiles,function(x){
  decode_scel(scel = x, 
              cpp = TRUE,
              output = str_c(x,&quot;.txt&quot;))
  }) %&gt;% invisible()

# 查看生成的文件
list.files(path = &quot;../../data/20171220-shediao/&quot;,pattern = &quot;.scel.txt$&quot;,full.names = T) </code></pre>
<pre><code>## [1] &quot;../../data/20171220-shediao/金庸独特地名.scel.txt&quot;              
## [2] &quot;../../data/20171220-shediao/金庸人名.scel.txt&quot;                  
## [3] &quot;../../data/20171220-shediao/金庸武功招式.scel.txt&quot;              
## [4] &quot;../../data/20171220-shediao/金庸武侠小说中出现的门派名.scel.txt&quot;
## [5] &quot;../../data/20171220-shediao/金庸小说武器.scel.txt&quot;              
## [6] &quot;../../data/20171220-shediao/金庸小说中的药物.scel.txt&quot;</code></pre>
<p>再把生成的这些jiebaR词库合并成一个文件：</p>
<pre class="r"><code>dictList &lt;- list.files(path = &quot;../../data/20171220-shediao/&quot;,
                       pattern = &quot;scel.txt$&quot;,
                       full.names = T)  
# 加入一些微调词语，例如上面词库里面没有的词语：蓉儿
dictList[length(dictList) + 1] &lt;- &quot;../../data/20171220-shediao/user.dict&quot;
dictToBeCombine &lt;- lapply(dictList,
                          function(x)
                            fread(x,encoding = &quot;UTF-8&quot;, header = FALSE))

# 合并词库
jinYongDict &lt;- rbindlist(dictToBeCombine) 

# 删除重复词条
jinYongDictUni &lt;- unique(jinYongDict, by = names(jinYongDict))  

# 写入文件保存
write.table(jinYongDictUni,file = &quot;../../data/20171220-shediao/jinYong.utf8.dict&quot;,
            quote = F,
            row.names = F,
            col.names = F,
            fileEncoding = &quot;UTF-8&quot;)</code></pre>
</div>
</div>
<div class="section level2">
<h2>分词处理</h2>
<pre class="r"><code>wk = worker(user = &quot;../../data/20171220-shediao/jinYong.utf8.dict&quot;)
novelText &lt;- read_lines(&quot;../../data/20171220-shediao/shediao.utf8.txt&quot;)
#segment(&quot;../../data/20171220-shediao/shediao.utf8.txt&quot;, wk)
wordFreq &lt;- wk[novelText]
freq(wordFreq) %&gt;% arrange(-freq) %&gt;% head</code></pre>
<pre><code>##   char  freq
## 1   的 11542
## 2   了 10564
## 3   他  7160
## 4   是  6000
## 5   我  5624
## 6   你  5307</code></pre>
<pre class="r"><code># 读入stop_words
stopWords &lt;- readLines(&quot;../../data/20171220-shediao/mystopword.txt&quot;, encoding = &#39;UTF-8&#39;)
# 去除stop_words
target_words = wordFreq[wordFreq%in%stopWords==FALSE]
freqTable &lt;- freq(target_words) %&gt;% arrange(-freq)
# 删除一些高词频无意义的词语
removeWords &lt;- c(&quot;道&quot;, &quot;听&quot;, &quot;说&quot;, &quot;中&quot;, &quot;想&quot;, &quot;之中&quot;, &quot;罢&quot;, &quot;走&quot;, &quot;做&quot;)
freqTable &lt;- freqTable %&gt;% dplyr::filter(!(char %in% removeWords))

freqTable %&gt;% head</code></pre>
<pre><code>##     char freq
## 1   郭靖 5000
## 2   黄蓉 3642
## 3 欧阳锋 1163
## 4 洪七公 1059
## 5   说道 1058
## 6   师父  875</code></pre>
</div>
<div class="section level2">
<h2>词云输出</h2>
<pre class="r"><code>library(widgetframe)
ts &lt;- wordcloud2(freqTable, color = &quot;random-light&quot;, backgroundColor = &#39;black&#39;)
frameWidget(ts)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:480px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"/post/2017-12-20-characters-relationship-in-novel-shediao_files/figure-html//widgets/widget_unnamed-chunk-6.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<div class="section level3">
<h3>人物云图</h3>
<p>关于<strong>金庸人名.scel</strong>这个词库，里面缺少<strong>成吉思汗</strong>这个重要人物，增加了<strong>完颜康</strong>等名字，还有<strong>欧阳锋</strong>这个名字错打成了<strong>欧阳峰</strong>，手工编辑了一个<code>shediao.renwu.user.dict</code>文件，然后合并到<code>金庸人名.scel.txt</code>，然后再读入。</p>
<pre class="r"><code># 加入了一些人名，例如蓉儿、完颜康、傻姑
file.append( &quot;../../data/20171220-shediao/金庸人名.scel.txt&quot;,
             &quot;../../data/20171220-shediao/shediao.renwu.user.dict&quot;)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>wkRenwu &lt;-  worker(user = &quot;../../data/20171220-shediao/金庸人名.scel.txt&quot;)
renwuTmp &lt;- wkRenwu[novelText]
freq(renwuTmp) %&gt;% arrange(-freq) %&gt;% head</code></pre>
<pre><code>##   char  freq
## 1   的 11543
## 2   了 10614
## 3   他  7159
## 4   是  5994
## 5   我  5624
## 6   你  5307</code></pre>
<pre class="r"><code># 读入stop_words
stopWords &lt;- readLines(&quot;../../data/20171220-shediao/mystopword.txt&quot;, encoding = &#39;UTF-8&#39;)
# 去除stop_words
targetRenwu &lt;-  renwuTmp[renwuTmp %in% stopWords == FALSE]
freqRenwu &lt;- freq(targetRenwu) %&gt;% arrange(-freq)
# 删除一些高词频无意义的词语
removeWords &lt;- c(&quot;道&quot;, &quot;听&quot;, &quot;说&quot;, &quot;中&quot;, &quot;想&quot;, &quot;之中&quot;, &quot;罢&quot;, &quot;走&quot;, &quot;做&quot;)
freqRenwu &lt;- freqRenwu %&gt;% dplyr::filter(!(char %in% removeWords))

# 帅选人名
renwuWords &lt;- fread(file = &quot;../../data/20171220-shediao/金庸人名.scel.txt&quot;, 
                    select = 1,
                    header = FALSE,
                    encoding = &quot;UTF-8&quot;)
freqRenwu2 = freqRenwu[freqRenwu$char%in%renwuWords[[&quot;V1&quot;]],]
freqRenwu2 %&gt;% dim</code></pre>
<pre><code>## [1] 153   2</code></pre>
<pre class="r"><code>wordcloud2(freqRenwu2, color = &quot;random-light&quot;, backgroundColor = &#39;grey25&#39;)</code></pre>
<div id="htmlwidget-2" style="width:672px;height:480px;" class="wordcloud2 html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"word":["郭靖","黄蓉","欧阳锋","洪七公","黄药师","周伯通","欧阳克","丘处机","梅超风","杨康","柯镇恶","裘千仞","铁木真","朱聪","成吉思汗","完颜洪烈","蓉儿","穆念慈","完颜康","拖雷","彭连虎","陆冠英","杨铁心","瑛姑","梁子翁","马钰","王处一","华筝","傻姑","包惜弱","老叫化","韩小莹","韩宝驹","侯通海","沙通天","鲁有脚","程瑶迦","尹志平","全金发","书生","段天德","渔人","南希仁","靖儿","一灯大师","灵智上人","桑昆","江南七怪","李萍","全真七子","术赤","郭啸天","汉子","王罕","窝阔台","都史","简长老","察合台","札木合","农夫","张阿生","陈玄风","七兄","博尔术","陆乘风","胖子","黎生","丘道长","彭长老","完颜洪熙","樵子","谭处端","曲三","孙不二","简管家","王道","枯木","裘千丈","木华黎","马道长","哑巴","郝大通","刘处玄","博尔忽","赤老温","张十五","蒙哥","大汉","忽必烈","吕文德","店伴","童子","小沙弥","马青雄","哑梢公","梁长老","钱青健","汤祖德","康儿","胖妇人","者勒米","书记","明月","余兆兴","上官","耶律楚材","吴青烈","沈青刚","长春真人","忽都虎","说不得","老头子","天竺僧人","盖运聪","乔寨主","焦木和尚","段智兴","李志常","瘦丐","莫大","明珠","阿里","清风","何足道","胖丐","书僮","神雕侠侣","射雕英雄传","教长","无常鬼","室里","大苦","朱元璋","祁志诚","王志坦","桃红","姜文","谭公","杨过","琴儿","宋德方","少妇","冯默风","曲傻姑","张三","马行空","教书先生","赵志敬","大头鬼","脚夫","铁匠","李四","克儿"],"freq":[5000,3605,1163,1059,868,678,611,609,485,439,427,415,364,360,357,347,335,323,305,272,263,263,250,242,238,216,216,209,197,192,191,188,179,179,175,145,140,133,127,125,122,114,110,105,103,99,97,94,91,90,89,85,85,85,85,82,80,75,75,75,73,68,64,61,61,58,58,53,49,40,39,37,35,33,33,32,31,30,30,28,27,26,26,24,24,23,22,22,22,19,18,18,17,15,15,14,14,14,14,12,12,11,11,11,10,9,9,9,9,8,8,8,8,8,7,7,6,6,6,6,6,5,5,5,4,4,3,3,3,3,3,3,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],"fontFamily":"Segoe UI","fontWeight":"bold","color":"random-light","minSize":0,"weightFactor":0.036,"backgroundColor":"grey25","gridSize":0,"minRotation":-0.785398163397448,"maxRotation":0.785398163397448,"shuffle":true,"rotateRatio":0.4,"shape":"circle","ellipticity":0.65,"figBase64":null,"hover":null},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level3">
<h3>人物关系图</h3>
<p>这里人物关系的算法的核心是，同一段落同时出现的名字之间的权重加1。</p>
<pre class="r"><code>novelText2 &lt;- novelText
renwuAll &lt;- freqRenwu2
novelText2 &lt;- novelText2[novelText2 != &quot;&quot;]

n &lt;- length(novelText2)
paragraphs &lt;- vector(&#39;list&#39;,n)
wk.engine &lt;-  worker(user = &quot;../../data/20171220-shediao/金庸人名.scel.txt&quot;)

for(i in 1:length(paragraphs)) paragraphs[[i]] = wk.engine[novelText2[i]][which(wk.engine[novelText2[i]] %in% renwuAll$char)]

weight.data &lt;- data.frame(t(combn(renwuAll$char,2)))
names(weight.data)=c(&#39;name1&#39;,&#39;name2&#39;)
weight.data &lt;- weight.data %&gt;% unite(col = &quot;weightName&quot;,
                      1:2, 
                      sep = &quot;-@-&quot;, 
                      remove = FALSE)

weight.data$weight &lt;- rep(0, dim(weight.data)[1])
for(i in 1:length(paragraphs)) {
  test &lt;- as.data.frame(table(paste(expand.grid(paragraphs[[i]],paragraphs[[i]])$Var1,expand.grid(paragraphs[[i]],paragraphs[[i]])$Var2,sep = &#39;-@-&#39;)), stringsAsFactors = FALSE)
  test$Freq = test$Freq/max(test$Freq)
  id1 &lt;- which(test$Var1 %in% weight.data$weightName)
  id2 &lt;- which(weight.data$weightName %in% test$Var1)
  weight.data$weight[id2] &lt;- weight.data$weight[id2] + test$Freq[id1]
}

weight.data %&gt;% arrange(-weight) %&gt;% head(20)</code></pre>
<pre><code>##         weightName  name1    name2    weight
## 1      郭靖-@-黄蓉   郭靖     黄蓉 318.10503
## 2    郭靖-@-欧阳锋   郭靖   欧阳锋  99.77610
## 3    郭靖-@-洪七公   郭靖   洪七公  88.08410
## 4    黄蓉-@-欧阳锋   黄蓉   欧阳锋  79.45635
## 5    黄蓉-@-洪七公   黄蓉   洪七公  71.55773
## 6    郭靖-@-黄药师   郭靖   黄药师  62.14189
## 7      郭靖-@-蓉儿   郭靖     蓉儿  60.85557
## 8    郭靖-@-周伯通   郭靖   周伯通  54.90627
## 9    黄蓉-@-欧阳克   黄蓉   欧阳克  54.29540
## 10   黄蓉-@-黄药师   黄蓉   黄药师  45.57725
## 11     黄蓉-@-蓉儿   黄蓉     蓉儿  44.14506
## 12 欧阳锋-@-洪七公 欧阳锋   洪七公  43.79671
## 13   郭靖-@-欧阳克   郭靖   欧阳克  42.22216
## 14   郭靖-@-梅超风   郭靖   梅超风  36.99572
## 15 郭靖-@-完颜洪烈   郭靖 完颜洪烈  32.59730
## 16     郭靖-@-杨康   郭靖     杨康  32.39271
## 17     黄蓉-@-杨康   黄蓉     杨康  32.16060
## 18     郭靖-@-朱聪   郭靖     朱聪  32.14538
## 19 杨铁心-@-郭啸天 杨铁心   郭啸天  31.91893
## 20 洪七公-@-欧阳克 洪七公   欧阳克  30.77956</code></pre>
<pre class="r"><code># 绘制关系图
paragraphs.chars &lt;- paragraphs %&gt;% unlist()
taltext &lt;- as.data.frame(table(wk.engine[paragraphs.chars][which(wk.engine[paragraphs.chars] %in% renwuAll$char)]))

ind3 &lt;- rep(0, dim(taltext)[1])
for(i in 1:dim(taltext)[1]) {
  ind3[i] = taltext$Freq[which(taltext$Var1[i] == renwuAll$char)]
}


# 画出人物关系图
library(igraph)
library(ggnetwork)
guanxi.data &lt;- weight.data[which(weight.data$weight != 0), ]
g1=guanxi.data %&gt;% 
  select(-weightName) %&gt;% 
  arrange(-weight) %&gt;% 
  slice(1:30) %&gt;%
  graph.data.frame(directed = F)

ggplot2::fortify(g1) %&gt;%
  ggplot(aes(x, y, xend = xend, yend = yend)) +
  geom_edges(linetype = 2, color = &quot;grey50&quot;,curvature = 0.1) +
  geom_nodes(aes(color =  vertex.names, size =  weight)) +
  geom_nodelabel_repel(aes(color = vertex.names, label = vertex.names),
                       fontface = &quot;bold&quot;, box.padding = unit(1, &quot;lines&quot;)) +
  theme(legend.position=&#39;none&#39;,
        axis.text = element_blank(),
        axis.title = element_blank(),
  panel.background = element_rect(fill = &quot;grey25&quot;),
  panel.grid = element_blank()
  )</code></pre>
<p><img src="/post/2017-12-20-characters-relationship-in-novel-shediao_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
</div>
<div class="section level2">
<h2>参考资料</h2>
<ul>
<li><a href="http://qinwenfeng.com/jiebaR/">jiebaR官方文档</a></li>
<li><a href="https://pinyin.sogou.com/dict/search/search_list/%BD%F0%D3%B9/normal">细胞词库下载地址</a></li>
<li><a href="http://blog.fens.me/r-word-jiebar/">R语言中文分词包jiebaR</a></li>
<li><a href="http://blog.csdn.net/nicolelovesmath/article/details/73835499" class="uri">http://blog.csdn.net/nicolelovesmath/article/details/73835499</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/26104216" class="uri">https://zhuanlan.zhihu.com/p/26104216</a></li>
</ul>
</div>
